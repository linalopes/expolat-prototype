<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixiJS Mesh Test - Proper ES Modules</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
        }
        #info {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>PixiJS Mesh Test - ES Modules Pattern</h1>
        <p>Following the official PixiJS example pattern with Prime Tower texture.</p>
    </div>

    <script type="module">
        import { Application, Assets, Graphics, Mesh, MeshGeometry, Point } from 'https://pixijs.download/release/pixi.mjs';

        console.log('Script starting with ES modules...');

        (async () => {
            try {
                // Create a new application
                const app = new Application();

                // Initialize the application
                await app.init({
                    width: 800,
                    height: 600,
                    backgroundColor: 0x1099bb
                });

                // Append the application canvas to the document body
                document.body.appendChild(app.canvas);

                console.log('✓ PixiJS app created successfully');

                // Load the prime tower texture
                console.log('Loading prime tower texture...');
                const texture = await Assets.load('images/prime.png');
                console.log('✓ Prime texture loaded:', {
                    valid: texture.valid,
                    width: texture.width,
                    height: texture.height
                });

                // Create mesh geometry - 4x4 grid like our main app
                const cols = 4;
                const rows = 4;
                const meshWidth = 300;
                const meshHeight = 400;

                const vertices = [];
                const uvs = [];
                const indices = [];

                // Generate vertices and UV coordinates
                for (let row = 0; row <= rows; row++) {
                    for (let col = 0; col <= cols; col++) {
                        // Vertex position (x, y)
                        const x = (col / cols) * meshWidth;
                        const y = (row / rows) * meshHeight;
                        vertices.push(x, y);

                        // UV coordinates (texture mapping)
                        const u = col / cols;
                        const v = row / rows;
                        uvs.push(u, v);
                    }
                }

                // Generate triangle indices
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const topLeft = row * (cols + 1) + col;
                        const topRight = topLeft + 1;
                        const bottomLeft = (row + 1) * (cols + 1) + col;
                        const bottomRight = bottomLeft + 1;

                        // First triangle
                        indices.push(topLeft, bottomLeft, topRight);
                        // Second triangle
                        indices.push(topRight, bottomLeft, bottomRight);
                    }
                }

                // Create PixiJS geometry
                const geometry = new MeshGeometry(vertices, uvs, indices);
                console.log('✓ Mesh geometry created');

                // Create mesh with texture
                const mesh = new Mesh({ geometry, texture });

                // Position mesh in center
                mesh.x = app.renderer.width / 2 - meshWidth / 2;
                mesh.y = app.renderer.height / 2 - meshHeight / 2;
                mesh.alpha = 1.0;

                console.log('✓ Mesh created and positioned:', {
                    x: mesh.x,
                    y: mesh.y,
                    visible: mesh.visible,
                    alpha: mesh.alpha
                });

                // Add to stage
                app.stage.addChild(mesh);
                console.log('✓ Mesh added to stage');

                // Add test sprite for comparison
                const testSprite = new PIXI.Sprite(texture);
                testSprite.x = 50;
                testSprite.y = 50;
                testSprite.width = 100;
                testSprite.height = 100;
                app.stage.addChild(testSprite);
                console.log('✓ Test sprite added for comparison');

                // Simple animation like the rope example
                let time = 0;
                app.ticker.add(() => {
                    time += 0.05;

                    // Get vertex buffer and deform like the rope example
                    const vertexBuffer = geometry.getBuffer('aPosition');
                    if (vertexBuffer && vertexBuffer.data) {
                        // Deform vertices with wave motion
                        for (let i = 0; i < vertices.length; i += 2) {
                            const originalX = vertices[i];
                            const originalY = vertices[i + 1];

                            // Simple wave deformation like the snake example
                            const waveX = Math.sin(time + originalY * 0.01) * 10;
                            const waveY = Math.cos(time + originalX * 0.01) * 8;

                            vertexBuffer.data[i] = originalX + waveX;
                            vertexBuffer.data[i + 1] = originalY + waveY;
                        }

                        // Update buffer
                        vertexBuffer.update();
                    }
                });

                console.log('✓ Animation started');

            } catch (error) {
                console.error('❌ Error:', error);
                document.body.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        })();
    </script>
</body>
</html>