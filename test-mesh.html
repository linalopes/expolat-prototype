<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixiJS Mesh Test with Prime.png</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
        }
        #container {
            width: 100%;
            height: 600px;
            border: 2px solid #fff;
            position: relative;
        }
        #info {
            margin-bottom: 20px;
        }
    </style>
    <script src="https://pixijs.download/release/pixi.min.js"></script>
</head>
<body>
    <div id="info">
        <h1>PixiJS Mesh Test with Prime.png</h1>
        <p>This should show a deforming mesh with the Prime Tower texture.</p>
    </div>
    <div id="container"></div>

    <script>
        console.log('Script starting...');
        console.log('PIXI available:', typeof PIXI);

        let app; // Define app in outer scope

        (async () => {
            try {
                console.log('Creating PIXI Application...');

                // Create and initialize PixiJS 8.x application
                app = new PIXI.Application();

                await app.init({
                    width: 800,
                    height: 600,
                    backgroundColor: 0x1099bb
                });

                // Append the application canvas to the container
                document.getElementById('container').appendChild(app.canvas);

                console.log('✓ PixiJS app created and initialized successfully');
                console.log('App properties:', {
                    hasScreen: !!app.screen,
                    hasRenderer: !!app.renderer,
                    hasStage: !!app.stage,
                    screenWidth: app.screen?.width,
                    rendererWidth: app.renderer?.width
                });

                // Load the prime tower texture using traditional method
                console.log('Attempting to load prime.png...');

                let texture;
                try {
                    // Try modern method first
                    if (PIXI.Assets && PIXI.Assets.load) {
                        texture = await PIXI.Assets.load('images/prime.png');
                    } else {
                        // Fallback to older method
                        texture = PIXI.Texture.from('images/prime.png');
                    }
                    console.log('✓ Prime.png loaded successfully:', texture);
                } catch (textureError) {
                    console.error('Texture loading failed:', textureError);
                    // Use white texture as fallback
                    texture = PIXI.Texture.WHITE;
                    console.log('Using white texture fallback');
                }

                // Create mesh geometry - 4x4 grid
                const cols = 4;
                const rows = 4;
                const meshWidth = 300;
                const meshHeight = 400;

                const vertices = [];
                const uvs = [];
                const indices = [];

                // Generate vertices and UV coordinates
                for (let row = 0; row <= rows; row++) {
                    for (let col = 0; col <= cols; col++) {
                        // Vertex position (x, y)
                        const x = (col / cols) * meshWidth;
                        const y = (row / rows) * meshHeight;
                        vertices.push(x, y);

                        // UV coordinates (texture mapping)
                        const u = col / cols;
                        const v = row / rows;
                        uvs.push(u, v);
                    }
                }

                // Generate triangle indices
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const topLeft = row * (cols + 1) + col;
                        const topRight = topLeft + 1;
                        const bottomLeft = (row + 1) * (cols + 1) + col;
                        const bottomRight = bottomLeft + 1;

                        // First triangle
                        indices.push(topLeft, bottomLeft, topRight);
                        // Second triangle
                        indices.push(topRight, bottomLeft, bottomRight);
                    }
                }

                // Create PixiJS geometry
                const geometry = new PIXI.MeshGeometry(vertices, uvs, indices);
                console.log('✓ Mesh geometry created:', geometry);

                // Create mesh with texture
                const mesh = new PIXI.Mesh(geometry, texture);

                // Position mesh in center (PixiJS 8.x compatible)
                const screenWidth = app.renderer.width || 800;
                const screenHeight = app.renderer.height || 600;
                mesh.x = screenWidth / 2 - meshWidth / 2;
                mesh.y = screenHeight / 2 - meshHeight / 2;
                mesh.alpha = 1.0; // Full opacity
                mesh.scale.set(1.0); // Ensure normal scale

                console.log('✓ Mesh created and positioned:', {
                    x: mesh.x,
                    y: mesh.y,
                    width: meshWidth,
                    height: meshHeight,
                    visible: mesh.visible,
                    alpha: mesh.alpha,
                    textureValid: texture.valid,
                    textureWidth: texture.width,
                    textureHeight: texture.height,
                    meshHasTexture: !!mesh.texture
                });

                // Add to stage
                app.stage.addChild(mesh);

                console.log('✓ Mesh added to stage');

                // First test without deformation to see if texture is visible
                console.log('✓ Static mesh created (no animation yet)');

                // Add a simple test rectangle to verify rendering works
                const testRect = new PIXI.Graphics();
                testRect.beginFill(0xff0000, 0.5); // Semi-transparent red
                testRect.drawRect(0, 0, 100, 100);
                testRect.endFill();
                testRect.x = 50;
                testRect.y = 50;
                app.stage.addChild(testRect);
                console.log('✓ Test rectangle added for comparison');

                // Test simple sprite with same texture to see if texture works at all
                const testSprite = new PIXI.Sprite(texture);
                testSprite.x = 600;
                testSprite.y = 100;
                testSprite.width = 150;
                testSprite.height = 150;
                app.stage.addChild(testSprite);
                console.log('✓ Test sprite added with same texture');

                // Uncomment below for animation once texture is visible:
                /*
                let time = 0;
                app.ticker.add(() => {
                    time += 0.05;

                    // Get vertex buffer
                    const vertexBuffer = geometry.getBuffer('aPosition');
                    if (vertexBuffer && vertexBuffer.data) {
                        // Deform vertices
                        for (let i = 0; i < vertices.length; i += 2) {
                            const originalX = vertices[i];
                            const originalY = vertices[i + 1];

                            // Add wave deformation
                            const waveX = Math.sin(time + originalY * 0.01) * 5;
                            const waveY = Math.cos(time + originalX * 0.01) * 5;

                            vertexBuffer.data[i] = originalX + waveX;
                            vertexBuffer.data[i + 1] = originalY + waveY;
                        }

                        // Update buffer
                        vertexBuffer.update();
                    }
                });
                */

                console.log('✓ Animation started');

            } catch (mainError) {
                console.error('❌ Error in main execution:', mainError);

                // Fallback: create a simple colored rectangle if app exists
                if (app && app.stage) {
                    const graphics = new PIXI.Graphics();
                    graphics.beginFill(0xff6b6b);
                    graphics.drawRect(0, 0, 300, 400);
                    graphics.endFill();

                    graphics.x = (app.renderer?.width || 800) / 2 - 150;
                    graphics.y = (app.renderer?.height || 600) / 2 - 200;

                    app.stage.addChild(graphics);
                    console.log('✓ Fallback rectangle created');
                } else {
                    console.log('❌ App not available for fallback');
                }
            }

        })().catch(error => {
            console.error('❌ Fatal error:', error);
            document.getElementById('container').innerHTML = `<p style="color: red;">Fatal Error: ${error.message}<br>Check console for details.</p>`;
        });
    </script>
</body>
</html>